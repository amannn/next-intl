import Callout from 'nextra-theme-docs/callout';

# Usage in Server Components (beta)

Next.js 13 introduces support for [React Server Components](https://beta.nextjs.org/docs/rendering/server-and-client-components) in the `app` directory. `next-intl` is adopting the new capabilities and is currently offering a beta version to early adopters, who are already building apps with the `app` directory.

<Callout>
  The `app` directory is currently in beta, patterns are still emerging and APIs
  may change. Please **use this at your own risk**, knowing that you might have
  to face a migration effort when the `app` directory becomes stable.
</Callout>

## Current beta version

```
npm install next-intl@2.11.0-beta.7
```

This beta version was tested with `next@13.1.1`.

## Roadmap

- âœ… All APIs from `next-intl` can be used in Server Components.
- ðŸ’¡ Currently SSR-only, i.e. you should use [CDN caching](https://youtu.be/bfLFHp7Sbkg?t=490) via [`headers` in `next.config.js`](https://nextjs.org/docs/api-reference/next.config.js/headers).

For details, see the [pending pull request for Server Components support](https://github.com/amannn/next-intl/pull/149).

## Getting started

If you haven't done so already, [create a Next.js 13 app that uses the `app` directory](https://beta.nextjs.org/docs/installation). All pages should be moved within a `[locale]` folder so that we can use this segment to provide content in different languages (e.g. `/en`, `/en/about`, etc.).

**Start by creating the following file structure:**

```
â”œâ”€â”€ messages (1)
â”‚   â”œâ”€â”€ en.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ i18n.tsx (2)
â”œâ”€â”€ next.config.js (3)
â”œâ”€â”€ middleware.tsx (4)
â””â”€â”€ app
    â””â”€â”€ [locale]
        â”œâ”€â”€ layout.tsx (5)
        â””â”€â”€ page.tsx (6)
```

**Now, set up the files as follows:**

1. Provide messages for a language, e.g. in `messages/en.json`:

```json
{
  "Index": {
    "title": "Hello world!"
  }
}
```

2. `next-intl` creates a configuration once per request and makes it available to all Server Components. Define this in `i18n.tsx` (short for "internationalization"):

```tsx
import {getRequestConfig} from 'next-intl/server';

export default getRequestConfig(async ({locale}) => ({
  messages: (await import(`../messages/${locale}.json`)).default
}));
```

3. Provide the path to your configuration in `next.config.js`:

```js
const withNextIntl = require('next-intl/plugin')(
  // This is the default, also the `src` folder is supported out of the box
  './i18n.tsx'
);

module.exports = withNextIntl({
  // Other Next.js configuration ...
  experimental: {appDir: true}
});
```

4. Create a [middleware](https://nextjs.org/docs/advanced-features/middleware) in `middleware.tsx`:

```tsx
import {createIntlMiddleware} from 'next-intl/server';

// The middleware intercepts requests to `/` and will redirect
// to one of the configured locales instead (e.g. `/en`).
// In the background a cookie is set that will remember the
// locale of the last page that the user has visited.
// The middleware furthermore passes the resolved locale
// to components in your app.
export default createIntlMiddleware({
  locales: ['en', 'de'],
  defaultLocale: 'en'
});

export const config = {
  // Skip all internal paths
  matcher: ['/((?!_next).*)']
};
```

5. Provide the matched `locale` to the document in `app/[locale]/layout.tsx`.

```tsx
import {useLocale} from 'next-intl';
import {notFound} from 'next/navigation';
import {ReactNode} from 'react';

type Props = {
  children: ReactNode;
  params: {locale: string};
};

export default function LocaleLayout({children, params}: Props) {
  const locale = useLocale();

  // Show a 404 error if the user requests an unknown locale
  if (params.locale !== locale) {
    notFound();
  }

  return (
    <html lang={locale}>
      <body>{children}</body>
    </html>
  );
}
```

6. Use translations in your page component in `app/[locale]/page.tsx` or anywhere else!

```tsx
import {useTranslations} from 'next-intl';

export default function Index() {
  const t = useTranslations('Index');
  return <h1>{t('title')}</h1>;
}
```

That's all it takes! Now you can internationalize your apps purely on the server side.

If you've encountered an issue, you can [explore the code for a working example](https://github.com/amannn/next-intl-example-next-13) ([demo](https://next-intl-example-next-13.vercel.app)).

If you're in a transitioning phase, either from the `pages` directory to the `app` directory, or from Client Components to the Server Components beta, you can apply `NextIntlClientProvider` additionally.

## Routing

In the `pages` folder, Next.js automatically considers the current locale for `next/link`. Since this is no longer the case for the `app` directory, `next-intl` provides a drop-in replacement for this use case.

```tsx
import {LocalizedLink} from 'next-intl';

// When the user is on `/en`, the link will point to `/en/about`
<LocalizedLink href="/about">About</LocalizedLink>

// You can override the `locale` to switch to another language
<LocalizedLink href="/" locale="de">Switch to German</LocalizedLink>
```

If you need to navigate programmatically (e.g. in response to a form submission), `next-intl` provides a convience API that wraps `useRouter` and automatically applies the locale of the user.

```tsx
'use client';

import {useLocalizedRouter} from 'next-intl/client';

const router = useLocalizedRouter();

// When the user is on `/en`, the router will navigate to `/en/about`
router.push('/about');
```

To retrieve the pathname without a locale prefix, you can call `useUnlocalizedPathname`.

```tsx
'use client';

import {useUnlocalizedPathname} from 'next-intl/client';

// When the user is on `/en`, this will be `/`
const pathname = useUnlocalizedPathname();
```

## Global request configuration

If you'd like to apply [global configuration](/docs/usage/configuration) like `formats`, `defaultTranslationValues`, `timeZone`, `now`, or [error handling functions](/docs/usage/error-handling) like `onError` and `getMessageFallback`, you can provide these in `i18n.tsx`.

```tsx
// i18n.tsx

import {headers} from 'next/headers';
import {getRequestConfig} from 'next-intl/server';

export default getRequestConfig(async ({locale}) => ({
  messages: (await import(`../messages/${locale}.json`)).default,

  // You can read from headers or cookies here if necessary
  timeZone: headers().get('x-time-zone') ?? 'Europe/Berlin'
}));
```

## Switching to Client Components

If you need to use translations in Client Components, the best approach is to pass the generated labels as props.

```tsx
import {useTranslations} from 'next-intl';
import Expandable from './Expandable';

export default function FrequentlyAskedQuestions() {
  const t = useTranslations('FrequentlyAskedQuestions');
  return <Expandable title={t('title')} description={t('description')} />;
}
```

```tsx
// app/[locale]/Expandable.tsx
'use client';

import {useState} from 'react';

function Expandable({title, description}) {
  const [expanded, setExpanded] = useState(false);

  function onToggle() {
    setExpanded(!expanded);
  }

  return (
    <div>
      <button onClick={onToggle}>{title}</button>
      {expanded && <p>{description}</p>}
    </div>
  );
}
```

This way your messages never leave the server and the client only needs to load the code that is necessary for initializing your interactive components.

If you absolutely need to use functionality from `next-intl` on the client side, you can wrap the respective components with `NextIntlClientProvider` ([example code](https://github.com/amannn/next-intl/blob/feat/next-13-rsc/packages/example-next-13-advanced/src/components/client/02-MessagesOnClientCounter/Counter.tsx)). Note however that this will increase your client bundle size.

## Providing feedback

If you have feedback about using `next-intl` in the `app` directory, feel free to leave feedback in [the PR which implements the React Server Components support](https://github.com/amannn/next-intl/pull/149).
