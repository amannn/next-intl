import Callout from 'nextra-theme-docs/callout';

# Usage in Server Components (preview)

Next.js 13 introduces support for [React Server Components](https://beta.nextjs.org/docs/rendering/server-and-client-components) in the `app` directory. `next-intl` is adopting the new capabilities and is currently offering a preview to early adopters, who are already building apps with the `app` directory.

<Callout>
  The `app` directory is currently in beta, patterns are still emerging and APIs
  may change. Please **use this at your own risk**, knowing that you might have
  to face a migration effort when the `app` directory becomes stable.
  `next-intl` tries to stay up to date with the latest developments on the
  Next.js side, but during this period there can be unexpected issues.
</Callout>

## Current preview version

```
npm install next-intl@2.11.0-alpha.8
```

This preview version was tested with `next@13.1.0`.

## Roadmap

- âœ… All APIs from `next-intl` can be used in Server Components.
- ðŸš§ The API to provide configuration to `next-intl` is still in flux.
- ðŸš§ Currently page transitions trigger a full page refresh (under investigation).

For details, see the [pending pull request for Server Components support](https://github.com/amannn/next-intl/pull/149).

## Getting started

If you haven't done so already, [create a Next.js 13 app that uses the `app` directory](https://beta.nextjs.org/docs/installation). The goal is to prefix all routes with the `locale`, so we can retrieve it as a [dynamic segment](https://beta.nextjs.org/docs/routing/defining-routes#dynamic-segments) and use it to configure `next-intl`.

**Start by creating the following file structure:**

```
â”œâ”€â”€ i18n.tsx (1)
â”œâ”€â”€ next.config.js (2)
â”œâ”€â”€ middleware.tsx (3)
â”œâ”€â”€ messages (4)
â”‚   â”œâ”€â”€ en.json
â”‚   â””â”€â”€ ...
â””â”€â”€ app
    â””â”€â”€ [locale]
        â””â”€â”€ page.tsx (5)
```

**Now, set up these files as follows:**

1. Define your configuration in `i18n.tsx`:

```tsx
import {NextIntlConfig} from 'next-intl';

const config: NextIntlConfig = {
  locales: ['en', 'de'],
  defaultLocale: 'en',
  async getMessages({locale}) {
    return (await import(`../messages/${locale}.json`)).default;
  }
};

export default config;
```

2. Link to your configuration in `next.config.js`:

```js
module.exports = {
  experimental: {appDir: true},
  webpack(config) {
    config.resolve.alias['next-intl/config'] = require.resolve('./i18n.tsx');
    return config;
  }
};
```

3. Create a [middleware](https://nextjs.org/docs/advanced-features/middleware) in `middleware.tsx`:

```tsx
import {createIntlMiddleware} from 'next-intl/server';

// The middleware intercepts requests to `/` and will redirect
// to one of the configured locales instead (e.g. `/en`).
// In the background a cookie is set that will remember the
// locale of the last page that the user has visited.
// The middleware furthermore passes runtime configuration
// to components in your app.
export default createIntlMiddleware();

export const config = {
  // Skip all internal paths
  matcher: ['/((?!_next).*)']
};
```

4. Set up messages for a language, e.g. in `messages/en.json`:

```json
{
  "Index": {
    "title": "Hello world!"
  }
}
```

5. Use translations in your page component in `app/[locale]/page.tsx` or anywhere else!

```tsx
import {useTranslations} from 'next-intl';

export default function Index() {
  const t = useTranslations('Index');
  return <h1>{t('title')}</h1>;
}
```

That's all it takes! Now you can internationalize your apps without adding i18n features to your client bundle.

If you've encountered an issue, you can [explore the code for a working example](https://github.com/amannn/next-intl-example-next-13) ([demo](https://next-intl-example-next-13.vercel.app)).

If you're in a transitioning phase, either from the `pages` directory to the `app` directory, or from Client Components the the Server Components preview, you can apply `NextIntlClientProvider` additionally.

## Linking between pages

In the `pages` folder, Next.js automatically considers the current locale for `next/link`. Since this is no longer the case for the `app` directory, `next-intl` provides a drop-in replacement for this use case.

```tsx
import {LocalizedLink} from 'next-intl';

// When the user is on `/en`, the link will point to `/en/about`
<LocalizedLink href="/about">About</LocalizedLink>

// You can override the `locale` to switch to another language
<LocalizedLink href="/" locale="de">Switch to German</LocalizedLink>
```

## Switching to Client Components

If you need to use translations in Client Components, the best approach is to pass the generated labels as props.

```tsx
// app/[locale]/page.tsx
import {useTranslations} from 'next-intl';
import Counter from './Counter';

export default function Index() {
  const t = useTranslations('Index');
  return <Counter title={t('counterTitle')} />;
}
```

```tsx
// app/[locale]/Counter.tsx
'use client';

import {useState} from 'react';

function Counter({title}) {
  const [count, setCount] = useState(0);

  function onIncrement() {
    setCount(count + 1);
  }

  return (
    <p>
      {title}: {count} <button onClick={onIncrement}>+</button>
    </p>
  );
}
```

This way your messages never leave the server and the client only needs to load the code that is necessary for initializing your interactive components.

If you absolutely need to use functionality from `next-intl` on the client side, you can wrap the respective components with `NextIntlClientProvider` ([example code](https://github.com/amannn/next-intl/blob/feat/next-13-rsc/packages/example-next-13-advanced/src/components/client/02-MessagesOnClientCounter/Counter.tsx)). Note however that this will increase your client bundle size.

## Providing feedback

If you have feedback about using `next-intl` in the `app` directory, feel free to leave feedback in [the PR which implements the React Server Components support](https://github.com/amannn/next-intl/pull/149).
